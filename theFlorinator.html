<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <title>The Florinator</title>
        <script type="text/javascript" src="js/phaser.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>
        <script type="text/javascript">
        var game = new Phaser.Game(1000, 700, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        var runningSpeed = 200;
        

        function preload(){
            game.load.spritesheet('runningStick', 'assets/runningStick.png', 40, 50, 7)
            game.load.image('florinatorSky', 'assets/florinatorSky.png')
            game.load.image('florinatorClouds', 'assets/florinatorClouds.png');
            game.load.image('ground', 'assets/ground.png');
            game.load.image('platformJump', 'assets/platform.png')
            game.load.image('deathWall', 'assets/deathWall.png')
            game.load.image('demon', 'assets/demonRobot.png')
            game.load.image('shot', 'assets/shots.png')
        }

        var fartinator;
        var sky;
        var clouds;
        var platforms;
        var platform;
        var ground;
        var grounds;
        var platformJump;
        var demons;
        var shots;
        var shot;
        var jumpTime = 0;
        var shootTime = 0;
        var deathTime = 0;

        function create(){
            
            game.physics.startSystem(Phaser.Physics.ARCADE)

            sky = game.add.tileSprite(0,
                game.height - game.cache.getImage('florinatorSky').height,
                game.width,
                game.cache.getImage('florinatorSky').height,
                'florinatorSky'
            );  

            clouds = game.add.tileSprite(0,
                500 - game.cache.getImage('florinatorClouds').height,
                game.width,
                game.cache.getImage('florinatorClouds').height,
                'florinatorClouds'
            );
            
            grounds = game.add.group();
            grounds.enableBody = true;
            grounds.physicsBodyType = Phaser.Physics.ARCADE;
            platforms = game.add.group();
            platforms.enableBody = true;

            ground = grounds.create(0, game.world.height - 30, 'ground');
            ground.body.immovable = true;
            ground.body.velocity.x = -10;
            
            platforms.physicsBodyType = Phaser.Physics.ARCADE;
            platforms.createMultiple(5, 'platformJump');
            platforms.setAll('outOfBoundsKill', true);
            platforms.setAll('checkWorldBounds', true);

            shots = game.add.group();
            shots.enableBody = true;
            shots.physicsBodyType = Phaser.Physics.ARCADE;
            shots.setAll('anchor.x', 0.5);
            shots.setAll('anchor.y', 1);
            shots.createMultiple(20, 'shot');
            shots.setAll('outOfBoundsKill', true);
            shots.setAll('checkWorldBounds', true);

            demons = game.add.group();
            demons.enableBody = true;
            demons.physicsBodyType = Phaser.Physics.ARCADE;
            

            createDemons();

            fartinator = game.add.sprite(150, game.world.height - 100, 'runningStick');
            game.physics.arcade.enable(fartinator);
            fartinator.body.gravity.y = 1000;
            fartinator.body.collideWorldBounds = true;
            fartinator.scale.set(1);
            fartinator.animations.add('right', [1, 2, 3, 4, 5], 1, true);
            fartinator.animations.add('up', [0], true);
            fartinator.animations.add('down', [6], true);
        }
        function update(){
            game.physics.arcade.overlap(fartinator, shots, playerKill, null, this)
            game.physics.arcade.collide(fartinator, platforms);
            game.physics.arcade.collide(fartinator, grounds);
            cursors = game.input.keyboard.createCursorKeys();
            clouds.tilePosition.x -= .3;
            fartinator.body.velocity.x = 0;
            
            fartinator.animations.play('right', 15, true);
            demonFires();
            moveDemons();
            // buildDeathWall();
            
 
            if(fartinator.body.touching.down && fartinator.body.center.y < 645)
            {
                fartinator.body.velocity.x = runningSpeed;
            }
            if(cursors.up.isDown && fartinator.body.touching.down){
                fartinator.body.velocity.y = -500;
                //this piece is broken for making platform disappear
                //game.destroy(platformJump);
            }
            if(fartinator.body.velocity.y < 0){
                fartinator.animations.play('up', true);
            }
            if(fartinator.body.velocity.y > 0){
                fartinator.animations.play('down', true);
                
            }
            if(cursors.right.isDown){
                buildPlatform();
            }
        }

        function createDemons(){
            demon = demons.create(game.world.width - 75, 200, 'demon');
            demon.body.collideWorldBounds = true;
            demon.anchor.setTo(.5, .5)

            // var tween = game.add.tween(demons).to( { y: 400 }, 2000, Phaser.Easing.Linear.None, true, 150, 150, true);
        }

        function demonFires(){
            if(game.time.now > shootTime){
                shot = shots.getFirstExists(false);
                if(shot)
                {
                    shot.reset(demon.body.x, demon.body.y);
                    shot.body.immovable = true;
                    shootTime = game.time.now + getRandomGameInt(500, 1500);
                }
                
                shot.body.velocity.x = -runningSpeed;
            }
        }

        function moveDemons(){
            if(demon.body.y <= 5){
                demon.body.velocity.y = 100;
            }
            demon.body.velocity.y = -100;
        }

        function buildPlatform(){
            if(game.time.now > jumpTime)
            {    
                platform = platforms.getFirstExists(false)
                if(platform)
                {
                    platform.reset(fartinator.body.center.x + 5, fartinator.body.center.y + 30);
                    platform.body.immovable = true;
                    platform.body.velocity.x = -runningSpeed;
                    fartinator.body.velocity.y = 0;
                    jumpTime = game.time.now + 400;
                }
            }
        }

        // function buildDeathWall(){
        //     if(game.time.now > deathTime)
        //     {
        //         var verticle = game.world.height;
        //         deathWall = deathWalls.getFirstExists(false);
        //         if(deathWall)
        //         {
        //             deathWall.reset(getRandomGameInt(game.world.width, game.world.width + 900), getRandomGameInt(-20, game.world.height))
        //             deathWall.body.immovable = true;
        //             deathWall.body.velocity.x = -runningSpeed;
        //             deathTime = game.time.now + getRandomGameInt(2, 3);
        //         }
        //     }
        // }

        function getRandomGameInt(min, max){
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function resetPlatform(platform){
            platform.kill();
        }

        function playerKill(fartinator){
            fartinator.kill();
            setTimeout(function(){ fartinator.revive(); }, 3000);

        }

        </script>
    </body>
</html>